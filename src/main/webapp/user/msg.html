<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <script src="/js/vue.global.js"></script>
    <script src="/js/axios.min.js"></script>
    <script src="/js/jquery-3.0.0.js"></script>
    <script src="/js/jquery.cookie.js"></script>
    <script src="/js/jq-paginator.min.js"></script>
    <script src="/js/msg.js"></script>
    <script src="/js/sweetalert2.all.min.js"></script>
    <script src="/js/sha1.min.js"></script>
    <script src="/js/flickity.pkgd.min.js"></script>
    <link rel="stylesheet" href="/css/flickity.css">
    <link rel="stylesheet" href="/css/picnic.css">
    <title>用户信息</title>
    <style>
        .active > a {
            background-color: #ddd !important;
        }

        .disabled {
            cursor: not-allowed !important;
            pointer-events: none !important;
        }

        .disabled a {
            color: #aaaaaa !important;
        }

        li {
            list-style: none;
            user-select: none;
        }

        .pagination > li > a:focus, .pagination > li > a:hover, .pagination > li > a > span:focus, .pagination > li > span:hover {
            z-index: 2;
            color: #23527c;
            background-color: #aaa;
            border-color: #ddd;
        }

        .pagination > li {
            display: inline;
        }

        .pagination > li > a, .pagination > li > span {
            position: relative;
            float: left;
            padding: 6px 12px;
            margin-left: 1px;
            line-height: 1.42;
            color: #337ab7;
            text-decoration: none;
            background-color: #fff;
            border: 1px solid #ddd;
        }

        #usertable tbody tr td {
            background-color: rgba(255, 255, 255, 0);
            line-height: 30px;
        }

        .usertable tbody tr {
            background-color: rgba(255, 255, 255, 0);
        }

        .usersetchangebtn td button {
            background-color: #ddd;
            color: black;
            margin-left: 10px;
            width: 270px;
        }

        .collecttd {
            border-left: #000000 solid 1px;
            border-right: #000000 solid 1px;
            border-bottom: #000000 solid 1px;
            border-top: #000000 solid 0;
            width: 1000px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        #collecttable table:first-child tr td{
            border-top: #000000 solid 1px;
        }
        #msgtable table:first-child tr td{
            border-top: #000000 solid 1px;
        }
        .collectp {
            width: 1000px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        #collecttable {
            margin-left: 10px;
            padding-bottom: 10px;
        }
        #msgtable {
            margin-left: 10px;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
<div id="header"></div>
<script>
    $(document).ready(function () {
        $("#header").load("/header.html")
    })
</script>
<div style="width: 1190px;margin: 0 auto;margin-top: 10px" id="userinformation">
    <div class="grid-content" style="background-color:rgba(255,255,255,0.8);">
        <table id="usermenu" hidden>
            <tr class="usersetchangebtn">
                <td colspan="2">
                    <button id="userinfobtn">
                        用户信息
                    </button>
                    <button id="usersetbtn">
                        用户设置
                    </button>
                    <button id="collectbtn">
                        用户收藏
                    </button>
                    <button id="msgbtn">
                        用户消息
                    </button>
                </td>
            </tr>
        </table>
        <table class="usertable" id="basictable" style="margin: 10px">
            <tr>
                <td>
                    头像:
                    <img :src="'/resource/img/upload/'+user.img" style="width: 100px;height: 100px;">
                </td>
            </tr>
            <tr>
                <td id="getuid">
                    uid:{{user.uid}}
                </td>
                <td>
                    邮箱状态:{{user.ifconfirmemail}}
                </td>
            </tr>
            <tr>
                <td>
                    用户名:{{user.username}}
                </td>
            </tr>
            <tr>
                <td>
                    简介:{{user.describes}}
                </td>
            </tr>
            <tr>
                <td>
                    用户组:{{usergroup.usergroup}}
                </td>
            </tr>
            <tr>
                <td>
                    发帖数:{{user.postcount}}
                </td>
            </tr>
            <tr>
                <td>
                    回复数:{{user.replycount}}
                </td>
            </tr>
            <tr>
                <td>
                    注册时间:{{user.registertime}}
                </td>
            </tr>
        </table>
        <table class="usertable" id="setpage" style="margin: 10px" hidden>
            <tr>
                <td>
                    头像:
                    <img :src="'/resource/img/upload/'+user.img" style="width: 100px;height: 100px;">
                </td>
                <td>
                    <button class="setbtn" id="changeiconbtn">
                        修改头像
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    邮箱:{{user.email}}
                </td>
                <td>
                    <button class="setbtn" id="changeemailbtn">
                        修改邮箱
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    密码:
                </td>
                <td>
                    <button class="setbtn" id="changepasswordbtn">
                        修改密码
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    用户名:{{user.username}}
                </td>
                <td>
                    <button class="setbtn" id="changeusernamebtn">
                        修改用户名
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    简介:{{user.describes}}
                </td>
                <td>
                    <button class="setbtn" id="changedescribebtn">
                        修改简介
                    </button>
                </td>
            </tr>
        </table>
        <div id="collecttable" hidden>
            <table v-for="c in collectlist">
                <tr>
                    <td class="collecttd">
                        <div class="collectp">
                            <a :href="'/Posts/'+c.pid+'?page=1'" style="color: black">{{c.title}}</a>
                        </div>
                    </td>
                </tr>
            </table>
            <ul class="pagination" style="height: 40px"></ul>
        </div>

        <div id="msgtable" hidden>
        <table v-for="m in messagelist">
            <tr>
                <td class="collecttd">
                    <div class="collectp">
                        <span v-if="m.uid!=10">
                            <a :href="'/user/msg/'+m.whoreplyuid">{{m.username}}</a>
                        </span>
                        {{m.msg}}
                        <span v-if="m.uid!=10">
                            <a :href="'/Posts/'+m.pid+'?page=1'">{{m.title}}</a>
                        </span>
                    </div>
                </td>
            </tr>
        </table>
        <ul class="pagination" style="height: 40px"></ul>
        </div>
    </div>

</div>

<script>


    $(document).ready(function () {

        $("#userinfobtn").click(function () {
            $("#setpage").hide()
            $("#collecttable").hide()
            $("#msgtable").hide()
            $("#basictable").show()
        })
        $("#usersetbtn").click(function () {
            $("#collecttable").hide()
            $("#msgtable").hide()
            $("#basictable").hide()
            $("#setpage").show()
        })
        $("#msgbtn").click(function () {
            $("#collecttable").hide()
            $("#basictable").hide()
            $("#setpage").hide()
            $("#msgtable").show()
            axios({
                method: "POST",
                url: "/getMessageListServlet",
                data: "page=1"
            }).then(function (resp) {
                v.messagelist = resp.data
                console.log(resp.data)
            }).catch(function (error) {
                console.log(error)
                Swal.fire(
                    {
                        icon: 'error',
                        title: "服务器无法处理该请求",
                        showConfirmButton: false,
                        timer: 2000
                    }
                )
            })
            axios({
                method: "post",
                url: "/getMessageCountServlet"
            }).then(function (resp) {
                msgtotalcount = resp.data.msgtotalcount
                console.log("totalcount=" + msgtotalcount)
                console.log("分页被初始化了")
                $('.pagination').jqPaginator({
                    totalCounts: Number(msgtotalcount),
                    pageSize: 10,
                    visiblePages: 10,
                    first: '<li class="first"><a href="javascript:void(0);">首页<\/a><\/li>',
                    prev: '<li class="prev"><a href="javascript:void(0);"><i class="arrow arrow2"><\/i>上一页<\/a><\/li>',
                    next: '<li class="next"><a href="javascript:void(0);">下一页<i class="arrow arrow3"><\/i><\/a><\/li>',
                    last: '<li class="last"><a href="javascript:void(0);">末页<\/a><\/li>',
                    page: '<li class="page"><a href="javascript:void(0);">{{page}}<\/a><\/li>',
                    currentPage: 1,
                    onPageChange: function (num, type) {
                        if (type == "change") {
                            axios({
                                method: "POST",
                                url: "/getMessageListServlet",
                                data: "page=" + num
                            }).then(function (resp) {
                                v.messagelist = resp.data
                                console.log(resp.data)
                            }).catch(function (error) {
                                console.log(error)
                                Swal.fire(
                                    {
                                        icon: 'error',
                                        title: "服务器无法处理该请求",
                                        showConfirmButton: false,
                                        timer: 2000
                                    }
                                )
                            })
                        }
                    }
                });
            })
        })
        $("#collectbtn").click(function () {
            $("#msgtable").hide()
            $("#basictable").hide()
            $("#setpage").hide()
            $("#collecttable").show()
            axios({
                method: "POST",
                url: "/getusercollectServlet",
                data: "page=1"
            }).then(function (resp) {
                v.collectlist = resp.data
                console.log(resp.data)
            }).catch(function (error) {
                console.log(error)
                Swal.fire(
                    {
                        icon: 'error',
                        title: "服务器无法处理该请求",
                        showConfirmButton: false,
                        timer: 2000
                    }
                )
            })
            axios({
                method: "post",
                url: "/getcollectcountServlet"
            }).then(function (resp) {
                totalcount = resp.data.totalcount
                console.log("totalcount=" + totalcount)
                console.log("分页被初始化了")
                $('.pagination').jqPaginator({
                    totalCounts: Number(totalcount),
                    pageSize: 10,
                    visiblePages: 10,
                    first: '<li class="first"><a href="javascript:void(0);">首页<\/a><\/li>',
                    prev: '<li class="prev"><a href="javascript:void(0);"><i class="arrow arrow2"><\/i>上一页<\/a><\/li>',
                    next: '<li class="next"><a href="javascript:void(0);">下一页<i class="arrow arrow3"><\/i><\/a><\/li>',
                    last: '<li class="last"><a href="javascript:void(0);">末页<\/a><\/li>',
                    page: '<li class="page"><a href="javascript:void(0);">{{page}}<\/a><\/li>',
                    currentPage: 1,
                    onPageChange: function (num, type) {
                        if (type == "change") {
                            axios({
                                method: "POST",
                                url: "/getusercollectServlet",
                                data: "page=" + num
                            }).then(function (resp) {
                                v.collectlist = resp.data
                                console.log(resp.data)
                            }).catch(function (error) {
                                console.log(error)
                                Swal.fire(
                                    {
                                        icon: 'error',
                                        title: "服务器无法处理该请求",
                                        showConfirmButton: false,
                                        timer: 2000
                                    }
                                )
                            })
                        }
                    }
                });
            })
        })


        $("#changeiconbtn").click(function () {
            swal.fire({
                title: "修改头像",
                html: `
                <form action="/uploadServlet" method="post" enctype="multipart/form-data">
                <p><input type="file" name="file1" id="uploadicon"></p>
                </form>
                `,
                showCancelButton: true,
                showConfirmButton: true,
                cancelButtonText: "取消",
            }).then((res) => {
                if (res.value) {
                    console.log("被执行了")
                    console.log($("#uploadicon"))
                    let file = $("#uploadicon")[0].files[0]
                    const formData=new FormData();
                    formData.append("uploadFile",file);
                    axios({
                        method: "POST",
                        url: "/uploadServlet",
                        enctype:"multipart/form-data",
                        data: formData
                    }).then(function (response) {
                        console.log(response.data)
                        if (response.data.msg == "修改成功") {
                            setTimeout("location.reload(true)", 1000)
                            Swal.fire(
                                {
                                    icon: 'success',
                                    title: response.data.msg,
                                    showConfirmButton: false,
                                    timer: 2000
                                }
                            )
                        } else {
                            Swal.fire(
                                {
                                    icon: 'error',
                                    title: response.data.msg,
                                    showConfirmButton: false,
                                    timer: 2000
                                }
                            )
                        }
                    })
                }
            })
        }).then(function (response) {
            console.log(response.data.msg)
            if (response.data.msg == "修改成功") {
                setTimeout("location.reload(true)", 1000)
                Swal.fire(
                    {
                        icon: 'success',
                        title: response.data.msg,
                        showConfirmButton: false,
                        timer: 2000
                    }
                )
            } else {
                Swal.fire(
                    {
                        icon: 'error',
                        title: response.data.msg,
                        showConfirmButton: false,
                        timer: 2000
                    }
                )
            }
        })
        $("#changeemailbtn").click(function () {
            Swal.fire({
                title: '修改用户名',
                html: `
            <form method="post" id="up1">
            <label>输入密码:
            <input type="password" name="password_confirm" id="password_confirm" form="up1">
            </label>
            <label>输入邮箱:
            <input type="text" name="change_uname_text" id="change_email_text" form="up1">
            </label>
            </form>
            `,
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonText: '修改',
                cancelButtonText: "取消",
                preConfirm: function () {
                    return new Promise((resolve, reject) => {
                        resolve({
                            password: $("#password_confirm").val(),
                            email: $("#change_email_text").val()
                        })
                    })
                },
            }).then((res) => {
                if (res.value) {
                    axios({
                        method: "POST",
                        url: "/changeemailServlet",
                        data: "email=" + $("#change_email_text").val() + "&password=" + sha1($("#password_confirm").val())
                    }).then(function (response) {
                        console.log(response.data.msg)
                        if (response.data.msg == "修改成功") {
                            setTimeout("location.reload(true)", 1000)
                            Swal.fire(
                                {
                                    icon: 'success',
                                    title: response.data.msg,
                                    showConfirmButton: false,
                                    timer: 2000
                                }
                            )
                        } else {
                            Swal.fire(
                                {
                                    icon: 'error',
                                    title: response.data.msg,
                                    showConfirmButton: false,
                                    timer: 2000
                                }
                            )
                        }
                    })
                }
            })
        })
        $("#changepasswordbtn").click(function () {
            Swal.fire({
                title: '修改密码',
                html: `
            <form method="post" id="up1">
            <label>输入原密码:
            <input type="password" name="password_origin" id="password_origin" form="up1">
            </label>
            <label>输入修改后密码:
            <input type="password" name="change_password" id="change_password" form="up1">
            </label>
            </form>
            `,
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonText: '修改',
                cancelButtonText: "取消",
                preConfirm: function () {
                    return new Promise((resolve, reject) => {
                        resolve({
                            password: $("#password_origin").val(),
                            afpassword: $("#change_password").val()
                        })
                    })
                },
            }).then((res) => {
                if (res.value) {
                    if ($("#change_password").val().length >= 6 && $("#change_password").val().length <= 16) {
                        axios({
                            method: "POST",
                            url: "/changepasswordServlet",
                            data: "password=" + sha1($("#password_origin").val()) + "&afpassword=" + sha1($("#change_password").val())
                        }).then(function (response) {
                            console.log(response.data.msg)
                            if (response.data.msg == "修改成功,请重新登录") {
                                $.cookie("uid", null, {expires: -1, path: "/"})
                                $.cookie("verifycode", null, {expires: -1, path: "/"})
                                setTimeout("location.reload(true)", 1000)
                                Swal.fire(
                                    {
                                        icon: 'success',
                                        title: response.data.msg,
                                        showConfirmButton: false,
                                        timer: 2000
                                    }
                                )
                            } else {
                                Swal.fire(
                                    {
                                        icon: 'error',
                                        title: response.data.msg,
                                        showConfirmButton: false,
                                        timer: 2000
                                    }
                                )
                            }
                        })
                    } else {
                        Swal.fire(
                            {
                                icon: 'error',
                                title: "密码长度不正确",
                                showConfirmButton: false,
                                timer: 2000
                            }
                        )
                    }
                }
            })
        })
        $("#changeusernamebtn").click(function () {
            Swal.fire({
                title: '修改用户名',
                html: `
            <form method="post" id="up1">
            <label>输入你想修改的用户名:
            <input type="text" name="change_username" id="change_username" form="up1">
            </label>
            </form>
            `,
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonText: '修改',
                cancelButtonText: "取消",
                preConfirm: function () {
                    return new Promise((resolve, reject) => {
                        resolve({
                            username: $("#change_username").val()
                        })
                    })
                },
            }).then((res) => {
                if (res.value) {
                    if ($("#change_username").val().length >= 3 && $("#change_username").val().length <= 10) {
                        axios({
                            method: "POST",
                            url: "/changeusernameServlet",
                            data: "username=" + $("#change_username").val()
                        }).then(function (response) {
                            console.log(response.data.msg)
                            if (response.data.msg == "修改成功") {
                                setTimeout("location.reload(true)", 1000)
                                Swal.fire(
                                    {
                                        icon: 'success',
                                        title: response.data.msg,
                                        showConfirmButton: false,
                                        timer: 2000
                                    }
                                )
                            } else {
                                Swal.fire(
                                    {
                                        icon: 'error',
                                        title: response.data.msg,
                                        showConfirmButton: false,
                                        timer: 2000
                                    }
                                )
                            }
                        })
                    } else {
                        Swal.fire(
                            {
                                icon: 'error',
                                title: "用户名长度不正确",
                                showConfirmButton: false,
                                timer: 2000
                            }
                        )
                    }
                }
            })
        })
        $("#changedescribebtn").click(function () {
            Swal.fire({
                title: '修改用户名',
                html: `
            <form method="post" id="up1">
            <label>输入你想修改的简介:
            <input type="text" name="change_describe" id="change_describe" form="up1">
            </label>
            </form>
            `,
                showCancelButton: true,
                showConfirmButton: true,
                confirmButtonText: '修改',
                cancelButtonText: "取消",
                preConfirm: function () {
                    return new Promise((resolve, reject) => {
                        resolve({
                            username: $("#change_describe").val()
                        })
                    })
                },
            }).then((res) => {
                if (res.value) {
                    axios({
                        method: "POST",
                        url: "/changedescribeServlet",
                        data: "describe=" + $("#change_describe").val()
                    }).then(function (response) {
                        if (response.data.msg == "修改成功") {
                            setTimeout("location.reload(true)", 1000)
                            Swal.fire(
                                {
                                    icon: 'success',
                                    title: response.data.msg,
                                    showConfirmButton: false,
                                    timer: 2000
                                }
                            )
                        } else {
                            Swal.fire(
                                {
                                    icon: 'error',
                                    title: response.data.msg,
                                    showConfirmButton: false,
                                    timer: 2000
                                }
                            )
                        }
                    })
                }
            })
        })


    })
    const {createApp} = Vue
    v = createApp({
        data() {
            return {
                user: [],
                usergroup: [],
                chakan: "msg",
                collectlist: [],
                messagelist:[]
            }
        },
        mounted() {
            var _this = this;
            URL = document.URL
            resourceposition = URL.indexOf("msg");
            resourceposition = resourceposition + 4
            postclass = URL.substring(resourceposition)
            axios({
                method: "post",
                url: "/userinformationServlet?reuid=" + postclass
            }).then(function (resp) {
                _this.user = resp.data
                console.log(resp.data)
                if (_this.user.ifconfirmemail == 1) {
                    _this.user.ifconfirmemail = "已验证"
                } else {
                    _this.user.ifconfirmemail = "未验证"
                }
                if (resp.data.uid == $.cookie("uid")) {
                    $("#usermenu").show()
                }
            })
            axios({
                method: "post",
                url: "/usergroupServlet?reuid=" + postclass
            }).then(function (resp) {
                _this.usergroup = resp.data
                console.log(resp.data)
            })
        }
    }).mount('#userinformation')
</script>
</body>
</html>